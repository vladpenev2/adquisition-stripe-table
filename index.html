<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Pricing</title>

    <!-- Stripe Pricing Table -->
    <script async src="https://js.stripe.com/v3/pricing-table.js"></script>

    <style>
      html, body {
        margin: 0;
        padding: 0;
        background: transparent;
      }

      body {
        display: flex;
        justify-content: center;
      }

      stripe-pricing-table {
        width: 100%;
        max-width: 980px;
      }
    </style>
  </head>

  <body>
    <stripe-pricing-table
      id="pricingTable"
      pricing-table-id="prctbl_1Sd6F4L7tv8OyZVQ34gW4RZ0"
      publishable-key="pk_live_51OFNEWL7tv8OyZVQ9YKUBbjbFUnVSeGTAdhp4XfAsShwHDxzmXvWKbBtQq3yrj16L9AuVIDWrVLSyZwq65fwhRGp00xr3C9LyP">
    </stripe-pricing-table>

    <script>
      // ---------- URL params ----------
      const params = new URLSearchParams(window.location.search);

      const email = params.get("email")
        ? decodeURIComponent(params.get("email"))
        : null;

      const sessionToken = params.get("session_token");

      const pricingTable = document.getElementById("pricingTable");

      // ---------- Helpers ----------
      function whenStripeReady(cb) {
        customElements.whenDefined("stripe-pricing-table").then(cb);
      }

      // ---------- Upgrade flow (existing customer) ----------
      async function attachCustomerSession(token) {
        try {
          const res = await fetch(
            "https://webhook-processor-production-3927.up.railway.app/webhook/stripe-customer-session",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ session_token: token })
            }
          );

          if (!res.ok) return;

          const data = await res.json();
          if (data?.client_secret) {
            whenStripeReady(() => {
              pricingTable.setAttribute(
                "customer-session-client-secret",
                data.client_secret
              );
            });
          }
        } catch (_) {
          // silent fail — pricing table still usable
        }
      }

      // ---------- Entry logic ----------
      if (sessionToken) {
        // Existing customer → upgrade / downgrade
        attachCustomerSession(sessionToken);
      } else if (email) {
        // New customer → prefill email
        whenStripeReady(() => {
          pricingTable.setAttribute("customer-email", email);
        });
      }
    </script>
  </body>
</html>
